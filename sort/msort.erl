-module(msort).
-compile(export_all).

sep(L, 0) -> {[], L};
sep([H|T], N) ->
    {Lleft, Lright} = sep(T, N-1),
    {[H|Lleft], Lright}.

merge([], L2) -> L2;
merge(L1, []) -> L1;
merge([H1|T1], [H2|T2]) when H1 =< H2 -> [H1|merge(T1,[H2|T2])];
merge([H1|T1], [H2|T2]) -> [H2|merge([H1|T1],T2)].

ms([]) -> [];
ms([A]) -> [A];
ms(L) ->
    {L1, L2} = sep(L, length(L) div 2),
    merge(ms(L1), ms(L2)).

% Concurrent version

call(Pid) -> receive
                {Pid, L} -> L
             end.

pms(L) -> Pid = spawn(msort, p_ms, [self(), L]),
          call(Pid).

p_ms(Pid, L) when length(L) < 100 -> Pid ! {self(), ms(L)};
p_ms(Pid, L) -> {Lleft, Lright} = sep(L, length(L) div 2),
                Pid1 = spawn(msort, p_ms, [self(), Lleft]),
                Pid2 = spawn(msort, p_ms, [self(), Lright]),
                L1 = call(Pid1),
                L2 = call(Pid2),
                Pid ! {self(), merge(L1, L2)}.

%test list
list() -> [86, 694, 747, 482, 944, 511, 436, 461, 149, 374, 224, 467, 819, 598, 851, 703, 620, 476, 497, 817, 765, 623, 158, 612, 16, 364, 875, 342, 38, 424, 309, 985, 27, 774, 519, 760, 103, 759, 793, 140, 458, 659, 229, 994, 334, 172, 340, 246, 357, 590, 269, 375, 754, 583, 190, 163, 508, 573, 753, 276, 256, 625, 43, 841, 420, 266, 159, 743, 56, 174, 535, 641, 804, 37, 60, 211, 673, 254, 892, 98, 579, 293, 800, 238, 480, 339, 788, 567, 113, 922, 230, 434, 66, 206, 936, 926, 669, 507, 57, 345, 779, 713, 489, 505, 250, 300, 303, 236, 227, 558, 200, 842, 111, 61, 208, 714, 597, 855, 690, 893, 289, 910, 4, 540, 775, 181, 586, 396, 235, 189, 450, 326, 899, 670, 977, 203, 71, 720, 166, 463, 471, 219, 609, 325, 451, 723, 722, 911, 542, 164, 870, 600, 761, 12, 290, 838, 483, 591, 574, 502, 317, 894, 728, 989, 808, 990, 47, 802, 818, 823, 349, 1000, 556, 440, 711, 169, 976, 155, 518, 927, 495, 430, 845, 578, 492, 135, 792, 603, 271, 273].